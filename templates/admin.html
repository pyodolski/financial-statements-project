<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>데이터 관리 - 손익계산서 변환기</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .password-section {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        margin: 100px auto;
      }

      .password-section h2 {
        margin-bottom: 20px;
        color: #333;
      }

      .password-input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
        text-align: center;
        letter-spacing: 2px;
      }

      .password-input:focus {
        outline: none;
        border-color: #4caf50;
      }

      .verify-btn {
        width: 100%;
        padding: 12px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .verify-btn:hover {
        background: #45a049;
      }

      .error-message {
        color: #f44336;
        margin-top: 10px;
        font-size: 14px;
      }

      .data-section {
        display: none;
      }

      .data-section.active {
        display: block;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .logout-btn {
        padding: 10px 20px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
      }

      .logout-btn:hover {
        background: #da190b;
      }

      .data-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #4caf50;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
      }

      .data-table tr:hover {
        background: #f5f5f5;
      }

      .download-btn {
        padding: 6px 12px;
        margin: 2px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
      }

      .download-btn:hover {
        background: #0b7dda;
      }

      .download-btn.output {
        background: #ff9800;
      }

      .download-btn.output:hover {
        background: #e68900;
      }

      .delete-btn {
        padding: 6px 12px;
        margin: 2px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .delete-btn:hover {
        background: #da190b;
      }

      .period-badge {
        display: inline-block;
        padding: 4px 8px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .stats-section {
        margin-bottom: 30px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .stat-card.success {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }

      .stat-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }

      .stat-card.warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
      }

      .monthly-stats {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .monthly-stats h3 {
        margin-bottom: 20px;
        color: #333;
      }

      .month-row {
        display: grid;
        grid-template-columns: 100px 1fr 1fr 1fr 1fr;
        gap: 15px;
        padding: 15px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .month-row:hover {
        background: #f5f5f5;
      }

      .month-row.header {
        font-weight: bold;
        background: #f8f9fa;
        border-bottom: 2px solid #ddd;
      }

      .month-label {
        font-weight: 600;
        color: #4caf50;
      }

      .month-value {
        text-align: right;
        font-weight: 500;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #eee;
      }

      .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }

      .tab.active {
        color: #4caf50;
        border-bottom-color: #4caf50;
        font-weight: 600;
      }

      .tab:hover {
        color: #4caf50;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <!-- 비밀번호 입력 섹션 -->
      <div class="password-section" id="passwordSection">
        <h2>🔒 데이터 관리</h2>
        <p style="color: #666; margin-bottom: 20px">비밀번호를 입력하세요</p>
        <input
          type="password"
          class="password-input"
          id="passwordInput"
          placeholder="비밀번호"
          maxlength="4"
        />
        <button class="verify-btn" onclick="verifyPassword()">확인</button>
        <div class="error-message" id="errorMessage"></div>
      </div>

      <!-- 데이터 관리 섹션 -->
      <div class="data-section" id="dataSection">
        <div class="header">
          <h1>📊 데이터 관리</h1>
          <div>
            <a href="/" class="logout-btn" style="margin-right: 10px">홈으로</a>
            <button class="logout-btn" onclick="logout()">로그아웃</button>
          </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="tabs">
          <button class="tab active" onclick="switchTab('statistics')">
            📈 통계
          </button>
          <button class="tab" onclick="switchTab('data')">
            📋 데이터 목록
          </button>
        </div>

        <!-- 통계 탭 -->
        <div class="tab-content active" id="statisticsTab">
          <div class="stats-section">
            <h2 style="margin-bottom: 20px">전체 통계</h2>
            <div class="stats-grid" id="totalStats">
              <div class="loading">통계를 불러오는 중...</div>
            </div>
          </div>

          <div class="monthly-stats">
            <h3>월별 통계</h3>
            <div id="monthlyStats">
              <div class="loading">월별 통계를 불러오는 중...</div>
            </div>
          </div>
        </div>

        <!-- 데이터 목록 탭 -->
        <div class="tab-content" id="dataTab">
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>거래기간</th>
                  <th>업로드 파일명</th>
                  <th>업로드 일시</th>
                  <th>총매출</th>
                  <th>매출총이익</th>
                  <th>다운로드</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody id="dataTableBody">
                <tr>
                  <td colspan="7" class="loading">데이터를 불러오는 중...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPassword = "";

      // Enter 키로 비밀번호 확인
      document
        .getElementById("passwordInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            verifyPassword();
          }
        });

      async function verifyPassword() {
        const password = document.getElementById("passwordInput").value;
        const errorMessage = document.getElementById("errorMessage");

        if (!password) {
          errorMessage.textContent = "비밀번호를 입력하세요";
          return;
        }

        try {
          const response = await fetch("/admin/verify", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password }),
          });

          const data = await response.json();

          if (data.success) {
            currentPassword = password;
            document.getElementById("passwordSection").style.display = "none";
            document.getElementById("dataSection").classList.add("active");
            loadStatistics(); // 통계 먼저 로드
            loadData();
          } else {
            errorMessage.textContent = "비밀번호가 올바르지 않습니다";
            document.getElementById("passwordInput").value = "";
          }
        } catch (error) {
          errorMessage.textContent = "오류가 발생했습니다";
          console.error("Error:", error);
        }
      }

      async function loadData() {
        try {
          const response = await fetch(
            `/admin/data?password=${currentPassword}`
          );
          const data = await response.json();

          const tbody = document.getElementById("dataTableBody");

          if (data.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">데이터가 없습니다</td></tr>';
            return;
          }

          tbody.innerHTML = data
            .map(
              (record) => `
                    <tr>
                        <td>
                            ${
                              record.transaction_period
                                ? `<span class="period-badge">${record.transaction_period}</span>`
                                : '<span style="color: #999;">-</span>'
                            }
                        </td>
                        <td>${record.upload_filename}</td>
                        <td>${new Date(record.upload_date).toLocaleString(
                          "ko-KR"
                        )}</td>
                        <td style="text-align: right; font-weight: 600;">${Number(
                          record.total_sales
                        ).toLocaleString()}원</td>
                        <td style="text-align: right; font-weight: 600; color: ${
                          record.gross_profit >= 0 ? "#4CAF50" : "#f44336"
                        };">
                            ${Number(record.gross_profit).toLocaleString()}원
                        </td>
                        <td>
                            <a href="/admin/download/input/${
                              record.id
                            }?password=${currentPassword}" 
                               class="download-btn" 
                               download>
                                📥 원본
                            </a>
                            <a href="/admin/download/output/${
                              record.id
                            }?password=${currentPassword}" 
                               class="download-btn output" 
                               download>
                                📊 손익계산서
                            </a>
                        </td>
                        <td>
                            <button class="delete-btn" onclick="deleteRecord(${
                              record.id
                            }, '${record.upload_filename}')">
                                🗑️ 삭제
                            </button>
                        </td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("dataTableBody").innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">데이터를 불러오는데 실패했습니다</td></tr>';
        }
      }

      async function deleteRecord(recordId, filename) {
        if (
          !confirm(
            `"${filename}" 데이터를 삭제하시겠습니까?\n\n원본 파일과 손익계산서가 모두 삭제됩니다.`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/admin/delete/${recordId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ password: currentPassword }),
          });

          const data = await response.json();

          if (data.success) {
            alert("삭제되었습니다");
            loadData(); // 데이터 새로고침
          } else {
            alert("삭제 실패: " + (data.error || "알 수 없는 오류"));
          }
        } catch (error) {
          console.error("Error deleting record:", error);
          alert("삭제 중 오류가 발생했습니다");
        }
      }

      function switchTab(tabName) {
        // 탭 버튼 활성화
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // 탭 컨텐츠 표시
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        if (tabName === "statistics") {
          document.getElementById("statisticsTab").classList.add("active");
          loadStatistics();
        } else if (tabName === "data") {
          document.getElementById("dataTab").classList.add("active");
        }
      }

      async function loadStatistics() {
        try {
          const response = await fetch(
            `/admin/statistics?password=${currentPassword}`
          );
          const data = await response.json();

          // 전체 통계 표시
          const totalStats = document.getElementById("totalStats");
          totalStats.innerHTML = `
            <div class="stat-card primary">
              <div class="stat-label">총 데이터</div>
              <div class="stat-value">${data.total.total_records}건</div>
            </div>
            <div class="stat-card success">
              <div class="stat-label">총 매출</div>
              <div class="stat-value">${Number(
                data.total.total_sales
              ).toLocaleString()}원</div>
            </div>
            <div class="stat-card info">
              <div class="stat-label">총 매출총이익</div>
              <div class="stat-value">${Number(
                data.total.gross_profit
              ).toLocaleString()}원</div>
            </div>
            <div class="stat-card warning">
              <div class="stat-label">평균 이익률</div>
              <div class="stat-value">${
                data.total.total_sales > 0
                  ? (
                      (data.total.gross_profit / data.total.total_sales) *
                      100
                    ).toFixed(1)
                  : 0
              }%</div>
            </div>
          `;

          // 월별 통계 표시
          const monthlyStats = document.getElementById("monthlyStats");
          if (data.monthly.length === 0) {
            monthlyStats.innerHTML =
              '<div style="text-align: center; padding: 40px; color: #999;">월별 데이터가 없습니다</div>';
            return;
          }

          monthlyStats.innerHTML = `
            <div class="month-row header">
              <div>월</div>
              <div style="text-align: right;">총매출</div>
              <div style="text-align: right;">매출원가</div>
              <div style="text-align: right;">매출총이익</div>
              <div style="text-align: right;">이익률</div>
            </div>
            ${data.monthly
              .map((month) => {
                const profitRate =
                  month.total_sales > 0
                    ? ((month.gross_profit / month.total_sales) * 100).toFixed(
                        1
                      )
                    : 0;
                return `
                <div class="month-row">
                  <div class="month-label">${month.month}</div>
                  <div class="month-value">${Number(
                    month.total_sales
                  ).toLocaleString()}원</div>
                  <div class="month-value">${Number(
                    month.total_cost
                  ).toLocaleString()}원</div>
                  <div class="month-value" style="color: ${
                    month.gross_profit >= 0 ? "#4CAF50" : "#f44336"
                  };">
                    ${Number(month.gross_profit).toLocaleString()}원
                  </div>
                  <div class="month-value" style="color: ${
                    profitRate >= 0 ? "#4CAF50" : "#f44336"
                  };">
                    ${profitRate}%
                  </div>
                </div>
              `;
              })
              .join("")}
          `;
        } catch (error) {
          console.error("Error loading statistics:", error);
          document.getElementById("totalStats").innerHTML =
            '<div style="text-align: center; padding: 40px; color: #f44336;">통계를 불러오는데 실패했습니다</div>';
        }
      }

      function logout() {
        currentPassword = "";
        document.getElementById("passwordSection").style.display = "block";
        document.getElementById("dataSection").classList.remove("active");
        document.getElementById("passwordInput").value = "";
        document.getElementById("errorMessage").textContent = "";
      }
    </script>
  </body>
</html>
